var se={};"undefined"!==typeof window&&(window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(new Date.now)},1E3/60)}}(),window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame);se.RectCollider=function(a){a=a||{};this.x=a.x;this.y=a.y;this.width=a.width;this.height=a.height;this.id=null;this.isStatic=null!=a.isStatic?a.isStatic:!1};se.RectCollider.createByExtent=function(a){return new se.RectCollider(a.min.x,a.min.y,a.max.x,a.max.y)};se.RectCollider.prototype.setParent=function(a){this.parent=a;null==this.width&&(a=a.mesh.getExtent(),this.x=a.min.x,this.y=a.min.y,this.width=a.max.x,this.height=a.max.y)};
se.RectCollider.prototype.getExtent=function(){var a=this.parent.transform.getRealPosition();return new se.Extent(a.x,a.y,a.x+this.width,a.y+this.height)};se.RectCollider.prototype.isIntersect=function(a){var b=this.getExtent();a=a.getExtent();return b.intersects(a)};se.RectCollider.prototype.getIntersection=function(a){if(a instanceof Array)for(var b in a){var c=a[b];if(this._isIntersect(c))return this._getIntersection(c)}else return this._getIntersection(a);return null};
se.RectCollider.prototype._getIntersection=function(a){var b=this.getExtent();a=a.getExtent();return b.getIntersection(a)};se.RectCollider.prototype.resolveCollision=function(a){this.parent.resolveCollision(a)};se.RectCollider.prototype.setStatic=function(a){this.isStatic=a};se.RectCollider.prototype.clone=function(){return new se.RectCollider(this.x,this.y,this.width,this.height)};se.ComponentScript=function(a,b){this.update=a||function(){};this.resolveCollision=b};se.ComponentScript.prototype.setParent=function(a){this.parent=a};se.ComponentPlatformPlayerController=function(a,b,c){this.joystick=a;this.speed=b||.5;this.jumpspeed=c||-13};
se.ComponentPlatformPlayerController.prototype.update=function(a,b){var c=this.joystick.getAxis("horizontal")*b/10,c=c||0,d=this.joystick.getAxis("jump");if(c||d){var e=a.rigidbody.body.velocity,c=e.x+c*this.speed,f=e.y;0<c?a.transform.rotate.x=1:0>c&&(a.transform.rotate.x=-1);16<c&&(c=16);-16>c&&(c=-16);d&&1>e.y&&-1<e.y&&(f=this.jumpspeed);a.rigidbody.setVelocity({x:c,y:f})}};se.ComponentPlatformPlayerController.prototype.setParent=function(a){this.parent=a};
se.ComponentFollowObject=function(a){this.obj_target=a};se.ComponentFollowObject.prototype.update=function(a){a.transform.position.x=this.obj_target.transform.position.x;a.transform.position.y=this.obj_target.transform.position.y};se.ComponentFollowObject.prototype.setParent=function(a){this.parent=a};se.FreeController=function(a,b){this.joystick=a;this.speed=b||1};se.FreeController.prototype.setParent=function(a){this.parent=a};
se.FreeController.prototype.update=function(a,b,c){a=this.joystick.getAxis("horizontal")||0;b=this.joystick.getAxis("vertical")||0;a&&(a*=this.speed);b&&(b*=this.speed);this.parent.transform.move(a,b)};se.Extent=function(a,b,c,d){this.min={x:a,y:b};this.max={x:c,y:d}};se.Extent.createEmpty=function(){return new se.Extent(Infinity,Infinity,-Infinity,-Infinity)};se.Extent.prototype.clone=function(){return new se.Extent(this.min.x,this.min.y,this.max.x,this.max.y)};se.Extent.prototype.move=function(a){this.min.x=a.x;this.min.y=a.y;this.max.x=a.x+this.getWidth();this.max.y=a.y+this.getHeight();return this};
se.Extent.prototype.extend=function(a){a.min.x<this.min.x&&(this.min.x=a.min.x);a.max.x>this.max.x&&(this.max.x=a.max.x);a.min.y<this.min.y&&(this.min.y=a.min.y);a.max.y>this.max.y&&(this.max.y=a.max.y);return this};se.Extent.prototype.extendVector=function(a){a.x<this.min.x&&(this.min.x=a.x);a.x>this.max.x&&(this.max.x=a.x);a.y<this.min.y&&(this.min.y=a.y);a.y>this.max.y&&(this.max.y=a.y);return this};se.Extent.prototype.extendVectors=function(a){for(var b in a)this.extendVector(a[b]);return this};
se.Extent.prototype.intersects=function(a){return this.min.x<=a.max.x&&this.max.x>=a.min.x&&this.min.y<=a.max.y&&this.max.y>=a.min.y};se.Extent.prototype.getIntersection=function(a){var b=se.Extent.createEmpty();if(this.intersects(a))b.min.x=this.min.x>a.min.x?this.min.x:a.min.x,b.min.y=this.min.y>a.min.y?this.min.y:a.min.y,b.max.x=this.max.x<a.max.x?this.max.x:a.max.x,b.max.y=this.max.y<a.max.y?this.max.y:a.max.y;else return null;return b};
se.Extent.prototype.getWidth=function(){return this.max.x-this.min.x};se.Extent.prototype.getHeight=function(){return this.max.y-this.min.y};se.factory={};se.factory.rect=function(a){var b=a||{},c=b.name||"",d=b.x||0,e=b.y||0;a=b.w||10;var f=b.h||10,g=b.image_src,h=b.fillColor||"#6B4226",k=b.rigidopts||{};null==b.hasRigidbody?hasRigidbody=!0:hasRigidbody=b.hasRigidbody;b=[new se.Vector(0,0),new se.Vector(a,0),new se.Vector(a,f),new se.Vector(0,f)];c=new se.GameObject(c,d,e,{vertices:b});hasRigidbody&&c.setRigidBody(new se.RigidBody(k));g?c.setRenderer(new se.ImageRenderer(g,a,f)):c.setRenderer(new se.RectRenderer(h,a,f));return c};
se.factory.circle=function(a){var b=a||{},c=b.name||"",d=b.x||0,e=b.y||0;a=b.radius||10;var f=b.rigidopts||{},g=b.maxSides||25;null==b.hasRigidbody?hasRigidbody=!0:hasRigidbody=b.hasRigidbody;var h=b.fillColor,k=b.strokeColor,b=b.lineWidth,g=se.factory.createCircleVertices(a,g),c=new se.GameObject(c,d,e,{vertices:g});hasRigidbody&&c.setRigidBody(new se.RigidBody(f));c.setRenderer(new se.CircleRenderer(a,h,k,b));return c};
se.factory.createCircleVertices=function(a,b){var c=Math.ceil(Math.max(10,Math.min(b||25,a)));1===c%2&&(c+=1);for(var d=2*Math.PI/c,e="",f=.5*d,g=0;g<c;g+=1)var h=f+g*d,k=Math.sin(h)*a,e=e+("L "+(Math.cos(h)*a).toFixed(3)+" "+k.toFixed(3)+" ");return Matter.Vertices.fromPath(e)};se.GameObject=function(a,b,c,d){this.name=a;this.transform=new se.Transform(this,b,c);this.components=[];this.colliders=[];this.parent=this.renderer=null;this.children=[];d=d||{};this.setMesh(new se.Mesh(d.vertices||[]));this.rigidbody=d.rigidbody||null;this.angle=0};se.GameObject.prototype.getX=function(){return this.transform.position.x};se.GameObject.prototype.getY=function(){return this.transform.position.y};se.GameObject.prototype.getWidth=function(){return this.width};
se.GameObject.prototype.getHeight=function(){return this.height};se.GameObject.prototype.getScene=function(){for(var a=this.parent;null!=a&&0==a instanceof se.Scene;)a=a.parent;return a};se.GameObject.prototype.getColliders=function(){return this.colliders};se.GameObject.prototype.setRenderer=function(a){a.setParent(this);this.renderer=a};
se.GameObject.prototype.update=function(a,b){this.rigidbody&&this.rigidbody.update(a,b);for(var c in this.components)this.components[c].update(this,a,b);for(c in this.children)this.children[c].update(a,b)};se.GameObject.prototype.resolveCollision=function(a){for(var b in this.components){var c=this.components[b];c.resolveCollision&&c.resolveCollision(a)}};
se.GameObject.prototype.render=function(a){var b=this.transform.position,c=this.transform.rotate;a.translate(b.x,b.y);a.rotate(this.angle);a.scale(c.x,1);this.renderer&&this.renderer.render(a);for(var d in this.children)this.children[d].render(a);a.scale(c.x,1);a.rotate(-this.angle);a.translate(-b.x,-b.y)};se.GameObject.prototype.addComponent=function(a){this.components.push(a);a.setParent(this);return this};
se.GameObject.prototype.addCollider=function(a){this.colliders.push(a);a.setParent(this);return this};se.GameObject.prototype.setRigidBody=function(a){this.rigidbody=a;a.setParent(this);return this};se.GameObject.prototype.setParent=function(a){this.parent=a};se.GameObject.prototype.addChild=function(a){this.children.push(a);a.setParent(this)};se.GameObject.prototype.removeChild=function(a){this.children.remove(a)};
se.GameObject.prototype.destroy=function(){this.parent instanceof se.GameObject&&this.parent.removeChild(this);this.getScene().remove(this)};se.GameObject.prototype.setMesh=function(a){this.mesh=a;a.setParent(this)};se.Transform=function(a,b,c){this.parent=a;this.position=new se.Vector(b,c);this.rotate=new se.Vector(1,0)};se.Transform.prototype.change=function(a,b){var c=this.parent.rigidbody;c?c.setPosition({x:a,y:b}):this.position.change(a,b)};
se.Transform.prototype.move=function(a,b){this.position.x+=a;this.position.y+=b};se.Transform.prototype.getRealPosition=function(){var a=this.position.x,b=this.position.y,c=this.parent.parent;c instanceof se.GameObject&&(a+=c.transform.position.x,b+=c.transform.position.y);return{x:a,y:b}};se.Joystick=function(){this.jump=!1;this.keyhandler=new se.KeyboardHandler(this)};se.Joystick.prototype.getAxis=function(a){return"horizontal"==a?this.x:"vertical"==a?this.y:"jump"==a?this.jump:0};se.Joystick.prototype.setAxis=function(a,b){"horizontal"==a&&(this.x=b);"vertical"==a&&(this.y=b);"jump"==a&&(this.jump=b)};se.Joystick.prototype.resetAxis=function(){this.y=this.x=0;this.jump=!1};
se.KeyboardHandler=function(a){var b=this;this.joy=a;document.addEventListener("keydown",function(a){b.keydown(a.keyCode)});document.addEventListener("keyup",function(a){b.keyup(a.keyCode)})};se.KeyboardHandler.prototype.keydown=function(a){"65"==a||"37"==a?this.joy.setAxis("horizontal",-1):"68"==a||"39"==a?this.joy.setAxis("horizontal",1):"87"==a?this.joy.setAxis("vertical",-1):"83"==a?this.joy.setAxis("vertical",1):"32"==a&&this.joy.setAxis("jump",!0)};
se.KeyboardHandler.prototype.keyup=function(a){"65"==a||"68"==a||"37"==a||"39"==a?this.joy.setAxis("horizontal",0):"87"==a||"83"==a?this.joy.setAxis("vertical",0):"32"==a&&this.joy.setAxis("jump",!1)};se.Mesh=function(a){this.vertices=a||[];var b=Matter.Vertices.centre(a);Matter.Vertices.translate(a,b,-1)};se.Mesh.prototype.setVertices=function(a){this.vertices=a};se.Mesh.prototype.getVertices=function(){return this.vertices};se.Mesh.prototype.getExtent=function(){var a=this.parent.transform.getRealPosition(),b=se.Extent.createEmpty();b.extendVectors(this.vertices);return b.move(a)};se.Mesh.prototype.setParent=function(a){this.parent=a};se.RectRenderer=function(a,b,c){this.color=a;this.width=b;this.height=c};se.RectRenderer.prototype.render=function(a){a.fillStyle=this.color;a.fillRect(-this.width/2,-this.height/2,this.width,this.height)};se.RectRenderer.prototype.setParent=function(a){this.parent=a};se.CircleRenderer=function(a,b,c,d){this.radius=a;this.fillStyle=b;this.strokeStyle=c;this.lineWidth=d||1};
se.CircleRenderer.prototype.render=function(a){a.beginPath();a.fillStyle=this.fillStyle;this.strokeStyle&&(a.strokeStyle=this.strokeStyle,a.lineWidth=this.lineWidth);a.arc(0,0,this.radius,0,2*Math.PI);a.fill();this.strokeStyle&&a.stroke()};se.CircleRenderer.prototype.setParent=function(a){this.parent=a};se.ImageRenderer=function(a,b,c){this.img=new Image;this.is_load=!1;this.img.src=a;this.width=b;this.height=c};
se.ImageRenderer.prototype.render=function(a){a.drawImage(this.img,-this.width/2,-this.height/2,this.width,this.height)};se.ImageRenderer.prototype.setParent=function(a){this.parent=a};se.GradientRenderer=function(a,b){this.color1=a||"#004CB3";this.color2=b||"#8ED6FF"};se.GradientRenderer.prototype.setParent=function(a){this.parent=a};
se.GradientRenderer.prototype.render=function(a,b){var c=a.createLinearGradient(150,0,150,300);c.addColorStop(0,this.color1);c.addColorStop(1,this.color2);a.fillStyle=c;a.fillRect(b.x,b.y,b.width,b.height)};se.MeshRenderer=function(a,b,c){this.color=a;this.strokeColor=b;this.lineWidth=c};se.MeshRenderer.prototype.setParent=function(a){this.parent=a};
se.MeshRenderer.prototype.render=function(a){var b=this.parent.transform.position,c=this.parent.rigidbody.body;a.translate(-b.x,-b.y);a.beginPath();a.moveTo(c.vertices[0].x,c.vertices[0]);for(var d=1;d<c.vertices.length;d++)a.lineTo(c.vertices[d].x,c.vertices[d].y);a.lineTo(c.vertices[0].x,c.vertices[0].y);a.closePath();a.fillStyle=this.color;this.strokeStyle&&(a.lineWidth=this.lineWidth,a.strokeStyle=this.strokeStyle,a.stroke());a.fill();a.translate(b.x,b.y)};se.RigidBody=function(a){this.options=a};se.RigidBody.prototype.createBody=function(){var a=this.parent,b=a.transform.position,c=this.options||{},d=c.x||b.x,b=c.y||b.y,e=c.name||a.name;null==c.canRotate&&(c.canRotate=!0);delete c.x;delete c.y;a={label:e,position:{x:d,y:b},vertices:a.mesh.getVertices()};this.body=Matter.Body.create(Matter.Common.extend({},a,c))};
se.RigidBody.prototype.update=function(a){a=this.parent.transform.position;a.x=this.body.position.x;a.y=this.body.position.y;this.parent.angle=this.body.angle};se.RigidBody.prototype.setParent=function(a){this.parent=a;this.createBody()};se.RigidBody.prototype.setVelocity=function(a){Matter.Sleeping.set(this.body,!1);Matter.Body.setVelocity(this.body,a)};se.RigidBody.prototype.applyForce=function(a,b){Matter.Body.applyForce(this.body,a,b)};
se.RigidBody.prototype.setAngularVelocity=function(a){Matter.Body.setAngularVelocity(this.body,a)};se.RigidBody.prototype.setPosition=function(a){Matter.Body.setPosition(this.body,a)};
Matter.Body.update=function(a,b,c,d){var e=Matter.Bounds,f=Matter.Vector,g=Matter.Vertices,h=Matter.Axes;b=Math.pow(b*c*a.timeScale,2);c=1-a.frictionAir*c*a.timeScale;var k=a.position.y-a.positionPrev.y;a.velocity.x=(a.position.x-a.positionPrev.x)*c*d+a.force.x/a.mass*b;a.velocity.y=k*c*d+a.force.y/a.mass*b;a.positionPrev.x=a.position.x;a.positionPrev.y=a.position.y;a.position.x+=a.velocity.x;a.position.y+=a.velocity.y;a.angularVelocity=a.canRotate?(a.angle-a.anglePrev)*c*d+a.torque/a.inertia*b:0;
a.anglePrev=a.angle;a.angle+=a.angularVelocity;a.speed=f.magnitude(a.velocity);a.angularSpeed=Math.abs(a.angularVelocity);for(d=0;d<a.parts.length;d++)b=a.parts[d],g.translate(b.vertices,a.velocity),0<d&&(b.position.x+=a.velocity.x,b.position.y+=a.velocity.y),0!==a.angularVelocity&&(g.rotate(b.vertices,a.angularVelocity,a.position),h.rotate(b.axes,a.angularVelocity),0<d&&f.rotateAbout(b.position,a.angularVelocity,a.position,b.position)),e.update(b.bounds,b.vertices,a.velocity)};se.Scene=function(a,b){this.parent=a;this.camera=new se.GameObject("MainCamera",0,0,0,0);this.pivot=new se.Transform(this,0,0);this.objs=[];this.colliders=[];this.add(this.camera);this.collisionsActive={};b?this.renderer=b:(this.renderer=new se.GradientRenderer("#8ED6FF","#004CB3"),this.renderer.setParent(this));this.matterengine=Matter.Engine.create(this.parent.element);this.matterengine.enableSleeping=!0};se.Scene.prototype.getWidth=function(){return this.parent.getWidth()};
se.Scene.prototype.getHeight=function(){return this.parent.getHeight()};se.Scene.prototype.getCamera=function(){return this.camera};se.Scene.prototype.getObjs=function(){return this.objs};se.Scene.prototype.setParent=function(a){this.parent=a};se.Scene.prototype.add=function(a){this.objs.push(a);a.setParent(this);a.rigidbody&&this.addBody(a.rigidbody.body);this.addColliders(a.getColliders())};
se.Scene.prototype.remove=function(a){var b=a.getColliders(),c;for(c in b){var d=this.colliders.indexOf(b[c]);-1!=d&&this.colliders.splice(d,1)}a.rigidbody&&this.removeBody(a.rigidbody.body);c=this.objs.indexOf(a);-1!=c&&this.objs.splice(c,1)};se.Scene.prototype.addBody=function(a){Matter.World.add(this.matterengine.world,a)};se.Scene.prototype.removeBody=function(a){Matter.Composite.removeBody(this.matterengine.world,a)};se.Scene.prototype.addColliders=function(a){for(var b in a)this.addCollider(a[b])};
se.Scene.prototype.addCollider=function(a){this.colliders.push(a);a.id=this.colliders.length-1};se.Scene.prototype.update=function(a,b){Matter.Engine.update(this.matterengine,a,b);this.checkColliders();for(var c in this.objs)this.objs[c].update(a,b)};
se.Scene.prototype.checkColliders=function(){var a=this.collisionsActive;this.collisionsActive={};for(var b=[],c=0;c<this.colliders.length-1;c++)for(var d=this.colliders[c],e=c+1;e<this.colliders.length;e++){var f=this.colliders[e];if((!d.isStatic||!f.isStatic)&&d.isIntersect(f)){var g=d.id+"-"+f.id,f={a:d,b:f};this.collisionsActive[g]=f;null==a[g]&&b.push(f)}}for(c in b)f=b[c],f.a.resolveCollision(f.b),f.b.resolveCollision(f.a)};
se.Scene.prototype.render=function(a){this.updatePivot(a);this.clearframe(a);this.renderBackground(a);for(var b in this.objs)this.objs[b].render(a)};se.Scene.prototype.renderBackground=function(a){this.renderer.render(a,{x:this.pivot.position.x,y:this.pivot.position.y,width:this.getWidth(),height:this.getHeight()})};se.Scene.prototype.clearframe=function(a){a.clearRect(this.pivot.position.x,this.pivot.position.y,this.getWidth(),this.getHeight())};
se.Scene.prototype.updatePivot=function(a){a.setTransform(1,0,0,1,0,0);var b=this.camera.transform.position,c=b.x-this.getWidth()/2,b=b.y-this.getHeight()/2;this.pivot.change(c,b);a.translate(-c,-b)};se.Scene.prototype.resetCamera=function(){this.pivot.change(0,0)};se.StarEngine=function(a){var b=this;this.element=a?document.getElementById(a):document.body;this.element.getContext&&(this.ctx=this.element.getContext("2d"));this.scenes=[];this.joystick=new se.Joystick;b.updateSize();window.addEventListener("resize",function(){b.getSceneCurrent().resetCamera();b.updateSize()});a={fps:60,correction:1,deltaSampleSize:60,counterTimestamp:0,frameCounter:0,deltaHistory:[],timePrev:null,timeScalePrev:1,frameRequestId:null,isFixed:!1,enabled:!0,timing:{timestamp:0,timeScale:1}};
a.delta=a.delta||1E3/a.fps;a.deltaMin=a.deltaMin||1E3/a.fps;a.deltaMax=a.deltaMax||1E3/(.5*a.fps);a.fps=1E3/a.delta;this.runner=a};se.StarEngine.prototype.getWidth=function(){return this.element.width};se.StarEngine.prototype.getHeight=function(){return this.element.height};se.StarEngine.prototype.getSceneCurrent=function(){return this.scenes[0]};se.StarEngine.prototype.setSize=function(a,b){this.element.width=a;this.element.height=b};
se.StarEngine.prototype.updateSize=function(){var a=this.element.parentElement;this.setSize(a.offsetWidth,a.offsetHeight)};se.StarEngine.prototype.getContext=function(){return this.ctx};se.StarEngine.prototype.addScene=function(a){this.scenes.push(a);a.setParent(this)};
se.StarEngine.prototype.update=function(a){var b=this.runner,c=b.timing,d=1,e;b.isFixed?e=b.delta:(e=a-b.timePrev||b.delta,b.timePrev=a,b.deltaHistory.push(e),b.deltaHistory=b.deltaHistory.slice(-b.deltaSampleSize),e=Math.min.apply(null,b.deltaHistory),e=e<b.deltaMin?b.deltaMin:e,e=e>b.deltaMax?b.deltaMax:e,d=e/b.delta,b.delta=e);0!==b.timeScalePrev&&(d*=c.timeScale/b.timeScalePrev);0===c.timeScale&&(d=0);b.timeScalePrev=c.timeScale;b.correction=d;b.frameCounter+=1;1E3<=a-b.counterTimestamp&&(b.fps=
(a-b.counterTimestamp)/1E3*b.frameCounter,b.counterTimestamp=a,b.frameCounter=0);a=this.getSceneCurrent();a.update(e,d);a.render(this.ctx)};se.StarEngine.prototype.run=function(){var a=this.runner,b=this;(function d(e){a.frameRequestId=window.requestAnimationFrame(d);e&&a.enabled&&b.update(e)})();return a};se.StarEngine.prototype.pause=function(a){null==a&&(a=!0);this.runner.enabled=!a};se.Vector=function(a,b){this.x=a;this.y=b};se.Vector.prototype.equals=function(a){return this.x==a.x&&this.y==a.y};se.Vector.prototype.clone=function(){return new se.Vector(this.x,this.y)};se.Vector.prototype.change=function(a,b){this.x=a;this.y=b};se.Vector.prototype.getMagnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};se.Vector.prototype.sub=function(a,b){var c;c=b?this:new se.Vector(0,0);c.x=this.x-a.x;c.y=this.y-a.y;return c};
se.Vector.prototype.add=function(a,b){var c;c=b?this:new se.Vector(0,0);c.x=this.x+a.x;c.y=this.y+a.y;return c};
